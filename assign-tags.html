<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スライドタグ編集 - Aki310 Slides</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="slideTagEditor()" x-cloak class="container mx-auto px-4 py-8">
        <!-- ヘッダー -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">スライドタグ編集</h1>
                    <p class="text-gray-600 mt-2">各スライドにタグを割り当てて分類できます</p>
                </div>
                <div class="flex space-x-2">
                    <a href="manage-tags.html" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                        タグ管理
                    </a>
                    <a href="index.html" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        スライド一覧
                    </a>
                </div>
            </div>
        </div>

        <!-- 一括操作 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">一括操作</h2>
            <div class="flex flex-wrap gap-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" x-model="selectAll" @change="toggleSelectAll()" 
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label class="text-sm text-gray-700">全て選択</label>
                </div>
                <template x-for="tag in tags" :key="tag.id">
                    <button @click="bulkAssignTag(tag.id)" 
                            :disabled="selectedSlides.length === 0"
                            class="px-3 py-1 rounded-full text-xs font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            :class="getTagColorClass(tag.color)"
                            x-text="'選択中のスライドに「' + tag.name + '」を追加'"></button>
                </template>
                <button @click="bulkRemoveSelected()" 
                        :disabled="selectedSlides.length === 0 || selectedTagForRemoval === ''"
                        class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    選択中のタグを削除
                </button>
                <select x-model="selectedTagForRemoval" 
                        class="px-2 py-1 text-xs border border-gray-300 rounded-md">
                    <option value="">削除対象タグを選択</option>
                    <template x-for="tag in tags" :key="tag.id">
                        <option :value="tag.id" x-text="tag.name"></option>
                    </template>
                </select>
            </div>
        </div>

        <!-- スライド一覧 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <template x-for="slide in slides" :key="slide.name">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" :value="slide.name" x-model="selectedSlides"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800" x-text="slide.title"></h3>
                                <p class="text-gray-600 text-sm" x-text="slide.description"></p>
                                <p class="text-gray-400 text-xs mt-1">
                                    <span x-text="slide.date"></span> | 
                                    <span x-text="slide.author"></span> | 
                                    <span x-text="slide.duration"></span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 現在のタグ -->
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">現在のタグ:</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tagId in (slide.tags || [])" :key="tagId">
                                <div class="flex items-center space-x-1">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium"
                                          :class="getTagColorClass(getTag(tagId)?.color || 'gray')"
                                          x-text="getTag(tagId)?.name || tagId"></span>
                                    <button @click="removeTagFromSlide(slide.name, tagId)"
                                            class="text-red-500 hover:text-red-700 text-xs">
                                        ×
                                    </button>
                                </div>
                            </template>
                            <div x-show="!slide.tags || slide.tags.length === 0" 
                                 class="text-gray-400 text-xs">
                                タグなし
                            </div>
                        </div>
                    </div>

                    <!-- タグ追加 -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">タグを追加:</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in getAvailableTagsForSlide(slide)" :key="tag.id">
                                <button @click="addTagToSlide(slide.name, tag.id)"
                                        class="px-2 py-1 rounded-full text-xs font-medium border-2 border-dashed transition-colors"
                                        :class="getTagBorderClass(tag.color)"
                                        x-text="tag.name"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- 保存ボタン -->
        <div class="fixed bottom-6 right-6">
            <button @click="saveChanges()" 
                    :disabled="!hasChanges"
                    class="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white px-6 py-3 rounded-full shadow-lg transition-colors">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>変更を保存</span>
                </div>
            </button>
        </div>

        <!-- 通知 -->
        <div x-show="showNotification" x-cloak
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform translate-y-2"
             class="fixed top-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <div class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span x-text="notificationMessage"></span>
            </div>
        </div>
    </div>

    <script>
        function slideTagEditor() {
            return {
                slides: [],
                tags: [],
                originalSlides: [],
                selectedSlides: [],
                selectAll: false,
                selectedTagForRemoval: '',
                showNotification: false,
                notificationMessage: '',

                init() {
                    this.loadTags();
                    this.loadSlides();
                },

                // タグとスライドの読み込み
                loadTags() {
                    const stored = localStorage.getItem('slide-tags');
                    if (stored) {
                        this.tags = JSON.parse(stored);
                    } else {
                        // デフォルトタグ
                        this.tags = [
                            {
                                id: 'default-tech',
                                name: 'Tech',
                                color: 'blue',
                                description: '技術系の発表',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 'default-business',
                                name: 'Business',
                                color: 'green',
                                description: 'ビジネス系の発表',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 'sre',
                                name: 'SRE',
                                color: 'purple',
                                description: 'Site Reliability Engineering関連',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 'conference',
                                name: 'Conference',
                                color: 'yellow',
                                description: 'カンファレンス関連',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 'slidev',
                                name: 'Slidev',
                                color: 'indigo',
                                description: 'Slidev関連',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 'vercel',
                                name: 'Vercel',
                                color: 'pink',
                                description: 'Vercel関連',
                                createdAt: new Date().toISOString()
                            }
                        ];
                        localStorage.setItem('slide-tags', JSON.stringify(this.tags));
                    }
                },

                async loadSlides() {
                    try {
                        // メタデータから読み込み
                        const response = await fetch('./config/slides-metadata.js');
                        const text = await response.text();
                        
                        const match = text.match(/export const slideMetadata = (\[[\s\S]*?\]);/);
                        if (match) {
                            this.slides = eval(match[1]);
                            this.originalSlides = JSON.parse(JSON.stringify(this.slides));
                        }
                    } catch (error) {
                        console.error('スライドメタデータの読み込みに失敗:', error);
                        // フォールバック
                        this.slides = [
                            {
                                name: 'sre-next-2025',
                                title: 'SRE NEXT 2025 - NoCスタッフ体験記',
                                description: 'SRE NEXT 2025でNoCスタッフをやった話とSRE NEXTの講演紹介',
                                date: '2025-07-17',
                                author: 'Satoru Akita',
                                category: 'tech-talk',
                                duration: '15分',
                                level: 'intermediate',
                                language: 'ja',
                                tags: ['default-tech', 'sre', 'conference']
                            },
                            {
                                name: 'slidev-system',
                                title: 'Slidev × Vercel 複数スライド管理システム',
                                description: '1つのリポジトリで複数のSlidevプレゼンテーションを効率的に管理する仕組みの解説',
                                date: '2025-07-18',
                                author: 'Satoru Akita',
                                category: 'system-design',
                                duration: '20分',
                                level: 'beginner',
                                language: 'ja',
                                tags: ['default-tech', 'default-business', 'slidev', 'vercel']
                            }
                        ];
                        this.originalSlides = JSON.parse(JSON.stringify(this.slides));
                    }
                },

                // ユーティリティ関数
                getTag(tagId) {
                    return this.tags.find(tag => tag.id === tagId);
                },

                getTagColorClass(color) {
                    const colors = {
                        blue: 'bg-blue-100 text-blue-800',
                        green: 'bg-green-100 text-green-800',
                        red: 'bg-red-100 text-red-800',
                        yellow: 'bg-yellow-100 text-yellow-800',
                        purple: 'bg-purple-100 text-purple-800',
                        pink: 'bg-pink-100 text-pink-800',
                        indigo: 'bg-indigo-100 text-indigo-800',
                        gray: 'bg-gray-100 text-gray-800'
                    };
                    return colors[color] || colors.blue;
                },

                getTagBorderClass(color) {
                    const colors = {
                        blue: 'border-blue-300 text-blue-600 hover:bg-blue-50',
                        green: 'border-green-300 text-green-600 hover:bg-green-50',
                        red: 'border-red-300 text-red-600 hover:bg-red-50',
                        yellow: 'border-yellow-300 text-yellow-600 hover:bg-yellow-50',
                        purple: 'border-purple-300 text-purple-600 hover:bg-purple-50',
                        pink: 'border-pink-300 text-pink-600 hover:bg-pink-50',
                        indigo: 'border-indigo-300 text-indigo-600 hover:bg-indigo-50',
                        gray: 'border-gray-300 text-gray-600 hover:bg-gray-50'
                    };
                    return colors[color] || colors.blue;
                },

                getAvailableTagsForSlide(slide) {
                    const slideTags = slide.tags || [];
                    return this.tags.filter(tag => !slideTags.includes(tag.id));
                },

                // タグ操作
                addTagToSlide(slideName, tagId) {
                    const slide = this.slides.find(s => s.name === slideName);
                    if (slide) {
                        if (!slide.tags) slide.tags = [];
                        if (!slide.tags.includes(tagId)) {
                            slide.tags.push(tagId);
                        }
                    }
                },

                removeTagFromSlide(slideName, tagId) {
                    const slide = this.slides.find(s => s.name === slideName);
                    if (slide && slide.tags) {
                        slide.tags = slide.tags.filter(id => id !== tagId);
                    }
                },

                // 一括操作
                toggleSelectAll() {
                    if (this.selectAll) {
                        this.selectedSlides = this.slides.map(slide => slide.name);
                    } else {
                        this.selectedSlides = [];
                    }
                },

                bulkAssignTag(tagId) {
                    this.selectedSlides.forEach(slideName => {
                        this.addTagToSlide(slideName, tagId);
                    });
                    this.showNotificationMessage(`選択したスライドに「${this.getTag(tagId)?.name}」タグを追加しました`);
                },

                bulkRemoveSelected() {
                    if (!this.selectedTagForRemoval) return;
                    
                    this.selectedSlides.forEach(slideName => {
                        this.removeTagFromSlide(slideName, this.selectedTagForRemoval);
                    });
                    this.showNotificationMessage(`選択したスライドから「${this.getTag(this.selectedTagForRemoval)?.name}」タグを削除しました`);
                    this.selectedTagForRemoval = '';
                },

                // 変更の確認
                get hasChanges() {
                    return JSON.stringify(this.slides) !== JSON.stringify(this.originalSlides);
                },

                // 保存機能
                saveChanges() {
                    // LocalStorageに保存
                    localStorage.setItem('slide-metadata-changes', JSON.stringify(this.slides));
                    
                    // 変更されたメタデータをJavaScript形式で生成
                    const jsContent = this.generateMetadataJS();
                    
                    // ダウンロード用のファイルを作成
                    const blob = new Blob([jsContent], { type: 'text/javascript' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'slides-metadata.js';
                    link.click();
                    URL.revokeObjectURL(url);

                    this.originalSlides = JSON.parse(JSON.stringify(this.slides));
                    this.showNotificationMessage('変更が保存されました。ダウンロードしたファイルを config/slides-metadata.js に置き換えてください。');
                },

                generateMetadataJS() {
                    let content = `// スライドメタデータ設定ファイル\n// 複数スライドの基本情報を一元管理\n\n`;
                    content += `export const slideMetadata = [\n`;
                    
                    this.slides.forEach((slide, index) => {
                        content += `  {\n`;
                        content += `    name: '${slide.name}',\n`;
                        content += `    title: '${slide.title}',\n`;
                        content += `    description: '${slide.description}',\n`;
                        content += `    date: '${slide.date}',\n`;
                        content += `    author: '${slide.author}',\n`;
                        content += `    category: '${slide.category}',\n`;
                        content += `    duration: '${slide.duration}',\n`;
                        content += `    level: '${slide.level}',\n`;
                        content += `    language: '${slide.language}',\n`;
                        
                        if (slide.tags && slide.tags.length > 0) {
                            content += `    tags: [${slide.tags.map(tag => `'${tag}'`).join(', ')}]\n`;
                        } else {
                            content += `    tags: []\n`;
                        }
                        
                        content += `  }${index < this.slides.length - 1 ? ',' : ''}\n`;
                    });
                    
                    content += `];\n\nexport default slideMetadata;\n`;
                    return content;
                },

                // 通知機能
                showNotificationMessage(message) {
                    this.notificationMessage = message;
                    this.showNotification = true;
                    setTimeout(() => {
                        this.showNotification = false;
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>